<!doctype html>
<html>
<head>
  <title>Environmental Health Channel</title>
  <link href="lib/geo-heatmap/GeoHeatmap.css" media="screen" rel="stylesheet" type="text/css"/>
  <link href="lib/slideshow/Slideshow.css" media="screen" rel="stylesheet" type="text/css"/>
  <link href="lib/color-scale-legend/ColorScaleLegend.css" media="screen" rel="stylesheet" type="text/css"/>
  <link href="css/viz.css" media="screen" rel="stylesheet" type="text/css"/>
  <link href="lib/parallel-coordinates/d3.parcoords.css" media="screen" rel="stylesheet" type="text/css"/>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Raleway:400,700' rel='stylesheet' type='text/css'>
  <link href="lib/jquery/jquery-ui.css" rel="stylesheet">
  <script src="lib/jquery/jquery.min.js"></script>
  <script src="lib/jquery/jquery-ui.min.js"></script>
  <script src="lib/d3/d3.v3.min.js"></script>
  <script src="lib/underscore/underscore-min.js"></script>
  <script src="lib/underscore/underscore-min.map"></script>
  <script src="lib/sylvester/sylvester.js"></script>
  <script src="lib/parallel-coordinates/d3.parcoords.js"></script>
  <script src="lib/parallel-coordinates/d3.underscore.math.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD_v1sFV-xzNf1avohIvUo9v9Fw8LHRA7w"></script>
  <script src="lib/geo-heatmap/GeoHeatmap.js" type="text/javascript"></script>
  <script src="lib/slideshow/Slideshow.js" type="text/javascript"></script>
  <script src="lib/color-scale-legend/ColorScaleLegend.js" type="text/javascript"></script>
  <script src="js/util.js" type="text/javascript"></script>
  <script src="js/viz.js" type="text/javascript"></script>
  <!-- Global Site Tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-10682694-22"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments)};
    gtag('js', new Date());
    gtag('config', 'UA-10682694-22');
  </script>
  <style>
    body {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      width: auto;
      height: auto;
      border: 0;
      margin: 0;
      font-family: 'Open Sans', sans-serif;
    }

    #viz-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      overflow-y: hidden;
    }
  </style>

  <script type="text/javascript">
    jQuery.support.cors = true;

    function loadData(flag) {
      if(flag == null){
          flag = "";
      }
      var data = {};
      var path = "data/";
      // Start loading data simultaneously
      $.when(
        // Load the table that maps zipcodes, bounds, and center positions
        $.getJSON(path + "zipcode_bound_geoJson.json", function (json) {
          data["zipcode_bound_geoJson"] = json;
        }).fail(function (response) {
          console.log("server error when loading zipcode_bound_geoJson.json:", response);
        }),
        // Load the GeoJSON that contains the zipcode boundaries which have Specks
        $.getJSON(path + "zipcode_bound_info.json", function (json) {
          data["zipcode_bound_info"] = json["data"];
        }).fail(function (response) {
          console.log("server error when loading zipcode_bound_info.json:", response);
        }),
        // Load the table that maps zipcodes and aggregated Speck analysis data
        $.getJSON(path + "speck_median_aggr_by_zipcode.json", function (json) {
          data["speck_analysis_aggr_by_zipcode"] = json;
        }).fail(function (response) {
          console.log("server error when loading speck_median_aggr_by_zipcode.json:", response);
        }),
        // Load the table that maps zipcodes and aggregated health analysis data
        $.getJSON(path + "health_percent_aggr_by_zipcode.json", function (json) {
          data["health_analysis_aggr_by_zipcode"] = json;
        }).fail(function (response) {
          console.log("server error when loading health_percent_aggr_by_zipcode.json:", response);
        }),
        // Load the speck data table
        $.getJSON(path + "speck_data.json", function (json) {
//          console.log(json);
          data["speck_data"] = json;
        }).fail(function (response) {
          console.log("server error when loading speck_data.json:", response);
        }),
        // Load the health data table
        $.getJSON(path + "health_data.json", function (json) {
          data["health_data"] = json;
        }).fail(function (response) {
          console.log("server error when loading health_data.json:", response);
        }),
        // Load the speck data table grouped by zipcode
        $.getJSON(path + "speck_data_group_by_zipcode.json", function (json) {
          data["speck_data_group_by_zipcode"] = json;
        }).fail(function (response) {
          console.log("server error when loading speck_data_group_by_zipcode.json:", response);
        }),
        // Load the health data table grouped by zipcode
        $.getJSON(path + "health_data_group_by_zipcode.json", function (json) {
          data["health_data_group_by_zipcode"] = json;
        }).fail(function (response) {
          console.log("server error when loading health_data_group_by_zipcode.json:", response);
        }),
        // Load the story data
        $.getJSON(path + "story_data.json", function (json) {
          data["story_data"] = json;
        }).fail(function (response) {
          console.log("server error when loading story_data.json:", response);
        }),
        $.getJSON(path + "time_ranges.json", function (json) {
          data["time_ranges"] = json;
          
          

        }).then(function (){
          for(i = 0; i < data["time_ranges"].length; i++){
             
              var flag = data["time_ranges"][i];
              console.log(flag)
              $.getJSON(path + "speck_median_aggr_by_zipcode" + flag + ".json").done(function (json1) {
                 data["speck_analysis_aggr_by_zipcode" + flag] = json1;
                 
                   
                }).fail(function (response) {
                  console.log("server error when loading speck_median_aggr_by_zipcode.json:", response);
                });
              
              console.log(data["speck_analysis_aggr_by_zipcode" + flag])
              
              $.getJSON(path + "speck_data_group_by_zipcode" + flag + ".json").done(function (json2) {
                  data["speck_data_group_by_zipcode" + flag] = json2;
//                  console.log( data["speck_data_group_by_zipcode" + flag]);
                }).fail(function (response) {
                  console.log("server error when loading speck_data_group_by_zipcode.json:", response);
                }),
              
              $.getJSON(path + "speck_data" + flag + ".json").done(function (json3) {
                  data["speck_data" + flag] = json3;
                  
                }).fail(function (response) {
                  console.log("server error when loading speck_data.json:", response);
                });
           
            }  
            
            
        }).fail(function (response) {
          console.log("server error when loading time_ranges.json:", response);
        }),
       

//        function({
//            var i = 0;
//            for(i = 0; i < data["time_ranges"].length; i++){
//             
//              var flag = data["time_ranges"][i];
//              $.getJSON(path + "speck_median_aggr_by_zipcode" + flag + ".json").done(function (json1) {
//                 data["speck_analysis_aggr_by_zipcode" + flag] = json1;
//                 
//                   
//                }).fail(function (response) {
//                  console.log("server error when loading speck_median_aggr_by_zipcode.json:", response);
//                });
//              
//              console.log(data["speck_analysis_aggr_by_zipcode" + flag])
//              
//              $.getJSON(path + "speck_data_group_by_zipcode" + flag + ".json").done(function (json2) {
//                  data["speck_data_group_by_zipcode" + flag] = json2;
//                  console.log( data["speck_data_group_by_zipcode" + flag]);
//                }).fail(function (response) {
//                  console.log("server error when loading speck_data_group_by_zipcode.json:", response);
//                }),
//              
//              $.getJSON(path + "speck_data" + flag + ".json").done(function (json3) {
//                  data["speck_data" + flag] = json3;
//                  
//                }).fail(function (response) {
//                  console.log("server error when loading speck_data.json:", response);
//                });
//            
//        }
//              
//             
//          
//          
//        }),
        
        
        //Load 
      ).then(function () {
          
        
        init(data);
      });
    }

    function init(data) {
      ehp_viz = new ehp.Viz("viz-container", {
        zipcode_bound_geoJson: data["zipcode_bound_geoJson"],
        zipcode_bound_info: data["zipcode_bound_info"],
        speck_analysis_aggr_by_zipcode: data["speck_analysis_aggr_by_zipcode"],
        health_analysis_aggr_by_zipcode: data["health_analysis_aggr_by_zipcode"],
        speck_data: data["speck_data"],
        health_data: data["health_data"],
        speck_data_group_by_zipcode: data["speck_data_group_by_zipcode"],
        health_data_group_by_zipcode: data["health_data_group_by_zipcode"],
        story_data: data["story_data"],
        time_ranges: data["time_ranges"]
        
      });
      console.log(data["time_ranges"].length);
      for(var i = 0; i < data["time_ranges"].length; i++){
          console.log(data["time_ranges"][i]);
          cur = data["time_ranges"][i];
          console.log(cur);
          console.log(data["speck_analysis_aggr_by_zipcode" + cur ])
          console.log(data["speck_data_group_by_zipcode" + cur ]);
          console.log(data["speck_data" + cur]);
          hello = new ehp.Viz("viz-container" + i, {
            zipcode_bound_geoJson: data["zipcode_bound_geoJson"],
            zipcode_bound_info: data["zipcode_bound_info"],
            speck_analysis_aggr_by_zipcode: data["speck_analysis_aggr_by_zipcode" + cur ],
            health_analysis_aggr_by_zipcode: data["health_analysis_aggr_by_zipcode"],
            speck_data: data["speck_data" + cur],
            health_data: data["health_data"],
            speck_data_group_by_zipcode: data["speck_data_group_by_zipcode" + cur ],
            health_data_group_by_zipcode: data["health_data_group_by_zipcode"],
            story_data: data["story_data"],
            time_ranges: data["time_ranges"]
          });
          console.log(hello);
          
         

          
          
          
      }
    }

    $(loadData(""));
  </script>
</head>
<body>
    
    
<div id="viz-container" class="noselect"></div>
<div id="viz-container0" class="noselect viz"></div>
<div id="viz-container1" class="noselect viz"></div>
<div id="viz-container2" class="noselect viz"></div>
<div id="viz-container3" class="noselect viz"></div>
<div id="viz-container4" class="noselect viz"></div>
<div id="viz-container5" class="noselect viz"></div>
<div id="viz-container6" class="noselect viz"></div>
<div id="viz-container7" class="noselect viz"></div>
<div id="viz-container8" class="noselect viz"></div>
<div id="viz-container9" class="noselect viz"></div>
<div id="viz-container10" class="noselect viz"></div>
<div id="viz-container11" class="noselect viz"></div>
<div id="viz-container12" class="noselect viz"></div>
<div id="viz-container13" class="noselect viz"></div>
<div id="viz-container14" class="noselect viz"></div>
<div id="viz-container15" class="noselect viz"></div>
<div id="viz-container16" class="noselect viz"></div>
<div id="viz-container17" class="noselect viz"></div>
<div id="viz-container18" class="noselect viz"></div>
<div id="viz-container19" class="noselect viz"></div>
<div id="viz-container20" class="noselect viz"></div>

    
    
</body>
</html>
